!function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=0)}([function(module,__webpack_exports__,__webpack_require__){"use strict";function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})}function __generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}__webpack_require__.r(__webpack_exports__),Object.setPrototypeOf||Array,Object.assign;var WHITESPACE_RE=/[\s]+/;function whitespaceTokenizer(text){return text.trim().split(WHITESPACE_RE)}var NWSTART_RE=/^\W+/,NWEND_RE=/\W+$/,InvertedIndexNode=function(charCode){this.charCode=charCode,this.next=null,this.firstChild=null,this.firstPosting=null};function createNodes(parent,term,start){for(;start<term.length;start++){var newNode=new InvertedIndexNode(term.charCodeAt(start));null===parent.firstChild?parent.firstChild=newNode:(newNode.next=parent.firstChild,parent.firstChild=newNode),parent=newNode}return parent}function findChild(node,charCode){for(var child=node.firstChild;null!==child;){if(child.charCode===charCode)return child;child=child.next}}var InvertedIndex=function(){function InvertedIndex(){this.root=new InvertedIndexNode(0)}return InvertedIndex.prototype.get=function(term){for(var node=this.root,i=0;i<term.length;i++)if(void 0===(node=findChild(node,term.charCodeAt(i))))return null;return node},InvertedIndex.prototype.add=function(term,docDetails,termFrequency){for(var node=this.root,i=0;i<term.length;i++){if(null===node.firstChild){node=createNodes(node,term,i);break}var nextNode=findChild(node,term.charCodeAt(i));if(void 0===nextNode){node=createNodes(node,term,i);break}node=nextNode}var pointer={next:null,details:docDetails,termFrequency:termFrequency};null===node.firstPosting?node.firstPosting=pointer:(pointer.next=node.firstPosting,node.firstPosting=pointer)},InvertedIndex.prototype.expandTerm=function(term){var node=this.get(term),results=[];return null!==node&&function _expandTerm(node,results,term){null!==node.firstPosting&&null!==node.firstPosting&&results.push(term);for(var child=node.firstChild;null!==child;)_expandTerm(child,results,term+String.fromCharCode(child.charCode)),child=child.next}(node,results,term),results},InvertedIndex.prototype.vacuum=function(){!function _vacuum(node){for(var prevPointer=null,pointer=node.firstPosting;null!==pointer;)pointer.details.removed?null===prevPointer?node.firstPosting=pointer.next:prevPointer.next=pointer.next:prevPointer=pointer,pointer=pointer.next;for(var child=node.firstChild;null!==child;)_vacuum(child),child=child.next}(this.root)},InvertedIndex}();function DEFAULT_FILTER(term){return function(term){return term.replace(NWSTART_RE,"").replace(NWEND_RE,"")}(function(term){return term.toLowerCase()}(term))}var document_index_DocumentIndex=function(){function DocumentIndex(options){if(this._documents=new Map,this._index=new InvertedIndex,this._fields=[],this._tokenizer=whitespaceTokenizer,this._filter=DEFAULT_FILTER,this._bm25k1=1.2,this._bm25b=.75,void 0!==options){void 0!==options.tokenizer&&(this._tokenizer=options.tokenizer),void 0!==options.filter&&(this._filter=options.filter);var bm25=options.bm25;void 0!==bm25&&(void 0!==bm25.k1&&(this._bm25k1=bm25.k1),void 0!==bm25.b&&(this._bm25b=bm25.b))}}return Object.defineProperty(DocumentIndex.prototype,"size",{get:function(){return this._documents.size},enumerable:!0,configurable:!0}),DocumentIndex.prototype.addField=function(fieldName,options){var getter=fieldName,boost=1;void 0!==options&&(void 0!==options.getter&&(getter=options.getter),void 0!==options.boost&&(boost=options.boost));var details={name:fieldName,getter:getter,boost:boost,sumLength:0,avgLength:0};this._fields.push(details)},DocumentIndex.prototype.add=function(documentId,document){for(var _this=this,documentTermCounts=new Array(this._fields.length),termCounts=new Map,i=0;i<this._fields.length;i++){var fieldDetails=this._fields[i],fieldAccessor=fieldDetails.getter,fieldValue="string"==typeof fieldAccessor?document[fieldAccessor]:fieldAccessor(document);if(void 0===fieldValue)documentTermCounts[i]=0;else{for(var terms=this._tokenizer(fieldValue),filteredTermsCount=0,j=0;j<terms.length;j++){var term=this._filter(terms[j]);if(""!==term){filteredTermsCount++;var counts=termCounts.get(term);void 0===counts&&(counts=new Array(this._fields.length).fill(0),termCounts.set(term,counts)),counts[i]+=1}}fieldDetails.sumLength+=filteredTermsCount,fieldDetails.avgLength=fieldDetails.sumLength/(this._documents.size+1),documentTermCounts[i]=filteredTermsCount}}var docDetails={docId:documentId,removed:!1,fieldLengths:documentTermCounts};this._documents.set(documentId,docDetails),termCounts.forEach(function(termCounters,term){_this._index.add(term,docDetails,termCounters)})},DocumentIndex.prototype.remove=function(documentId){var details=this._documents.get(documentId);if(void 0!==details){details.removed=!0,this._documents.delete(documentId);for(var i=0;i<this._fields.length;i++){var fieldLength=details.fieldLengths[i];if(fieldLength>0){var field=this._fields[i];field.sumLength-=fieldLength,field.avgLength=field.sumLength/this._documents.size}}}},DocumentIndex.prototype.search=function(query){for(var queryTerms=this._tokenizer(query),scores=new Map,i=0;i<queryTerms.length;i++){var term=this._filter(queryTerms[i]);if(""!==term)for(var expandedTerms=this._index.expandTerm(term),documents=new Set,j=0;j<expandedTerms.length;j++){var eTerm=expandedTerms[j],expansionBoost=eTerm===term?1:Math.log(1+1/(1+eTerm.length-term.length)),termNode=this._index.get(eTerm);if(null!==termNode&&null!==termNode.firstPosting){for(var documentFrequency=0,pointer=termNode.firstPosting,prevPointer=null;null!==pointer;)pointer.details.removed?null===prevPointer?termNode.firstPosting=pointer.next:prevPointer.next=pointer.next:(prevPointer=pointer,documentFrequency++),pointer=pointer.next;if(documentFrequency>0){var idf=Math.log(1+(this.size-documentFrequency+.5)/(documentFrequency+.5));for(pointer=termNode.firstPosting;null!==pointer;){if(!pointer.details.removed){for(var score=0,x=0;x<pointer.details.fieldLengths.length;x++){var tf=pointer.termFrequency[x];if(tf>0){var fieldLength=pointer.details.fieldLengths[x],fieldDetails=this._fields[x],avgFieldLength=fieldDetails.avgLength,k1=this._bm25k1,b=this._bm25b;score+=(tf=(k1+1)*tf/(k1*(1-b+b*(fieldLength/avgFieldLength))+tf))*idf*fieldDetails.boost*expansionBoost}}if(score>0){var docId=pointer.details.docId,prevScore=scores.get(docId);void 0!==prevScore&&documents.has(docId)?scores.set(docId,Math.max(prevScore,score)):scores.set(docId,void 0===prevScore?score:prevScore+score),documents.add(docId)}}pointer=pointer.next}}}}}var result=[];return scores.forEach(function(score,documentId){result.push({docId:documentId,score:score})}),result.sort(function(a,b){return b.score-a.score}),result},DocumentIndex.prototype.expandTerm=function(term){return this._index.expandTerm(term)},DocumentIndex.prototype.queryToTerms=function(query){for(var result=[],tokens=this._tokenizer(query),i=0;i<tokens.length;i++){var term=this._filter(tokens[i]);""!==term&&(result=result.concat(this._index.expandTerm(term)))}return result},DocumentIndex.prototype.vacuum=function(){this._index.vacuum()},DocumentIndex}();function emitStateChange(state){postMessage({type:"state",state:state})}!function(){__awaiter(this,void 0,void 0,function(){var db,comments,index,_i,comments_2,comment;return __generator(this,function(_a){switch(_a.label){case 0:return emitStateChange(1),[4,new Promise(function(resolve,reject){var req=indexedDB.open("docs",1);req.onerror=function(e){reject(req.error)},req.onsuccess=function(e){resolve(req.result)},req.onupgradeneeded=function(e){var db=req.result;db.objectStoreNames.contains("comments")||db.createObjectStore("comments",{autoIncrement:!0})}})];case 1:return db=_a.sent(),emitStateChange(2),[4,function(db){return new Promise(function(resolve,reject){var req=db.transaction("comments").objectStore("comments").count();req.onerror=function(e){reject(req.error)},req.onsuccess=function(e){resolve(req.result)}})}(db)];case 2:return 0!==_a.sent()?[3,4]:[4,function(url){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4,fetch("data/reddit_comments.json")];case 1:return[4,_a.sent().json()];case 2:return[2,_a.sent().map(function(d,i){return{id:i,author:d.author,body:d.body}})]}})})}()];case 3:return comments=_a.sent(),emitStateChange(3),function(db,comments){new Promise(function(resolve,reject){var transaction=db.transaction("comments","readwrite");transaction.onerror=function(e){reject(transaction.error)},transaction.oncomplete=function(e){resolve()};for(var commentsStore=transaction.objectStore("comments"),_i=0,comments_1=comments;_i<comments_1.length;_i++){var comment=comments_1[_i];commentsStore.add(comment)}})}(db,comments),[3,6];case 4:return[4,function(db){return new Promise(function(resolve,reject){var result=[],cursor=db.transaction("comments").objectStore("comments").openCursor();cursor.onerror=function(e){reject(cursor.error)},cursor.onsuccess=function(e){var cursor=e.target.result;cursor?(result.push(cursor.value),cursor.continue()):resolve(result)}})}(db)];case 5:comments=_a.sent(),_a.label=6;case 6:for(emitStateChange(4),(index=new document_index_DocumentIndex).addField("author"),index.addField("body"),_i=0,comments_2=comments;_i<comments_2.length;_i++)comment=comments_2[_i],index.add(comment.id,comment);return emitStateChange(5),onmessage=function(e){var id,results,req=e.data;switch(req.type){case"query":id=req.id,results=index.search(req.query).slice(0,50).map(function(r){return{comment:comments[r.docId],score:r.score}}),postMessage({type:"query",id:id,results:results})}},[2]}})})}()}]);